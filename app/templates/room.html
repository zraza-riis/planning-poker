{% extends 'base.html' %}

{% block content %}

<style>

    .hidden{
        display: none;
    }

    #gamearea {
        display: flex;
        flex-direction: column;
    }
    #gamearea .content {
        flex: 1;
    }

    #choices .col.poker {
        height: 125px;
        background-color: rgb(32, 85, 130);
        margin: 10px;
        border-radius: 7px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2.5rem;
    }

    #choices .col.poker:hover {
        background-color: rgb(63, 114, 159);
    }
</style>

<div class="row" style="max-width: 100%;">
    <div class="col-9">
        <div class="container text-center" style="height: 82vh;" id="gamearea">
            <div class="content">
                <br>
                <h1>You have joined room "{{ room.name }}"</h1>
                <br>
                <h4>Invite your team members with the following link: </h4>
                <p>
                    <a href="{{ room.join_link }}">{{ room.join_link }}</a>
                </p>
                <br>
                <h5>Connected Users:</h5>
                <ul id="connectedPlayersList"></ul>
            
                <br>
                <h5>Estimations:</h5>
                <ul id="estimationsList"></ul>
            </div>

            <div class="row" id="choices">
                <div class="col"></div>
                <div class="col"></div>
                <div class="col poker">
                    <p>0</p>
                </div>
                <div class="col poker">
                    <p>1</p>
                </div>
                <div class="col poker">
                    <p>2</p>
                </div>
                <div class="col poker">
                    <p>3</p>
                </div>
                <div class="col poker">
                    <p>5</p>
                </div>
                <div class="col poker">
                    <p>8</p>
                </div>
                <div class="col poker">
                    <p>13</p>
                </div>
                <div class="col"></div>
                <div class="col"></div>
            </div>
        </div>
    </div>
    <div class="col-3 bg-body" style="height: 82vh; overflow-y: auto; overflow-x: hidden;">
        <div class="container">
            <br>
            <h1 class="text-center">Issues</h1>
            <br>
            <div id="prompts">
            </div>
            <p class="text-center">
                <br>
                <button id="newissuebtn" class="btn btn-secondary" onclick="showissueform()">+ New Issue</button>
                <form id="promptForm" style="border-radius: 5px;" class="p-3 bg-body-secondary hidden">
                    <input type="text" class="form-control" id="promptInput" placeholder="Enter title for issue" required>
                    <textarea id="promptDescription" class="form-control" placeholder="Enter your description"></textarea>
                    <button type="submit" class="form-control btn btn-primary btn-sm">Submit</button>
                </form>
            </p>
        </div>
    </div>
</div>
<script>
    function showissueform(){
        let newissuebtn = document.getElementById('newissuebtn');
        let promptForm = document.getElementById('promptForm');
        newissuebtn.classList.add('hidden');
        promptForm.classList.remove('hidden');
    }

    function submitNewIssue(){
        alert('New issue submitted')
    }

</script>

<script type="text/javascript">
    var socket = io.connect();

    socket.on('connect', function() {
        console.log('Connected to server');
        socket.emit('join_room', {'room_uuid': '{{ room.uuid }}'});
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from server');
        socket.emit('leave_room', {'room_uuid': '{{ room.uuid }}'});
    });

    socket.on('new_room', function(data) {
        console.log('New room created:', data.room_uuid);
    });

    // Handle a new Prompt getting created
    socket.on('new_prompt', function(data) {
        console.log('New prompt submitted:', data.prompt_id, data.prompt_title, data.prompt_description);
        prompthtml = createPromptHTML(data.prompt_title, data.prompt_description, data.prompt_id);
        document.getElementById('prompts').innerHTML+=prompthtml;
        let newissuebtn = document.getElementById('newissuebtn');
        let promptForm = document.getElementById('promptForm');
        newissuebtn.classList.remove('hidden');
        promptForm.classList.add('hidden');
    });

    socket.on('player_joined', function(data) {
        console.log('Player joined:', data.player_name);
        updateConnectedPlayersList(data.players);
    });

    socket.on('player_left', function(data) {
        console.log('Player left:', data.player_name);
        updateConnectedPlayersList(data.players);
    });

    // Handle a new active prompt for the room being set
    socket.on('active_prompt_changed', function(data) {
        let prompt_id = data.prompt_id;
        let active_prompt = document.getElementById(`prompt-${prompt_id}`);
        let active_prompt_btn = document.getElementById(`prompt-btn-${prompt_id}`);
        let prompts = document.getElementsByClassName('prompt');
        let prompt_btns = document.getElementsByClassName('prompt-btn');
        
        for(let prompt of prompts){
            prompt.classList.remove('bg-body-secondary');
        }
        for(let btn of prompt_btns){
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-primary');
            btn.innerText = 'Vote This Issue'
        }
        active_prompt.classList.add('bg-body-secondary');
        active_prompt_btn.classList.remove('btn-primary');
        active_prompt_btn.classList.add('btn-secondary');
        active_prompt_btn.innerText = "Voting Now..."
        console.log('New active prompt:', data.prompt_id, data.prompt_title, data.prompt_description);
    });

    // Handle a new estimation for the player being set
    socket.on('new_estimation', function(data) {
        console.log('New estimation submitted:', data.player_name, data.estimation_value, data.estimations);
        updateEstimationsList(data.player_name, data.estimation_value);
    });

    document.getElementById('promptForm').addEventListener('submit', function(event) {
        event.preventDefault();

        var promptInput = document.getElementById('promptInput').value;
        var promptDescription = document.getElementById('promptDescription').value;

        socket.emit('new_prompt', {'room_uuid': '{{ room.uuid }}', 'prompt_title': promptInput, 'prompt_description': promptDescription});

        document.getElementById('promptInput').value = '';
        document.getElementById('promptDescription').value = '';

    });

    // Call this function when requesting a new active prompt
    function voteActivePrompt(prompt_id) {
        socket.emit('new_active_prompt', {'room_uuid': '{{ room.uuid }}', 'prompt_id': prompt_id})
    }

    // Call this function when submitting a new estimation
    function newEstimationSubmitted(estimationValue) {
        socket.emit('new_estimation_submitted', {'room_uuid': '{{ room.uuid }}', 'estimation_value': estimationValue})
    }

    function updateConnectedPlayersList(players) {
        var playersListElement = document.getElementById('connectedPlayersList');
        playersListElement.innerHTML = '';

        players.forEach(function(player) {
            var listItem = document.createElement('li');
            listItem.textContent = player;
            playersListElement.appendChild(listItem);
        });
    }

    function updateEstimationsList(playerName, estimationValue) {
        var estimationsListElement = document.getElementById('estimationsList');
        var listItem = document.createElement('li');
        listItem.textContent = playerName + ': ' + estimationValue;
        estimationsListElement.appendChild(listItem);
    }

    function createPromptHTML(issue_name, issue_desc, issue_id){
        return `
        <div class="card mt-2 prompt" id="prompt-${issue_id}">
            <div class="card-body">
                <h5 class="card-title">${issue_name}</h5>
                <p class="card-text">${issue_desc}</p>
                <button onclick="voteActivePrompt(${issue_id})" id="prompt-btn-${issue_id}" class="prompt-btn btn btn-sm btn-primary">Vote This Issue</a>
            </div>
        </div>
        `
    }
    
</script>

{% endblock %}